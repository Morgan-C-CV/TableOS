# 公网IP获取问题排查指南

## 问题描述
应用显示"公网IP获取失败 - 仅支持局域网"，无法获取公网IP地址。

## 可能的原因

### 1. 网络环境限制
- **企业网络/校园网**: 可能阻止HTTPS外部连接
- **防火墙设置**: 阻止应用访问外部IP查询服务
- **代理服务器**: 网络通过代理访问，阻止直接连接

### 2. 网络连接问题
- **网络不稳定**: 连接超时或中断
- **DNS解析失败**: 无法解析IP查询服务域名
- **移动网络限制**: 某些运营商可能限制特定服务访问

## 解决方案

### 应用层面的改进 ✅
我们已经实现了以下改进：

1. **多服务备用**: 使用5个不同的IP查询服务
2. **HTTP备用**: 当HTTPS服务无法访问时，自动尝试HTTP服务
3. **详细错误信息**: 在日志中显示具体的失败原因
4. **超时优化**: 调整连接超时时间，提高成功率

### 用户可以尝试的解决方法

#### 方法1: 检查网络连接
```bash
# 测试基本网络连接
ping 8.8.8.8

# 测试HTTP连接
curl http://httpbin.org/ip

# 测试HTTPS连接  
curl https://api.ipify.org
```

#### 方法2: 更换网络环境
- 尝试使用手机热点
- 连接到不同的WiFi网络
- 使用移动数据网络

#### 方法3: 检查防火墙设置
- 临时关闭防火墙测试
- 添加应用到防火墙白名单
- 检查企业网络策略

## 技术实现细节

### 当前使用的IP查询服务
1. **HTTPS服务** (优先):
   - https://api.ipify.org
   - https://checkip.amazonaws.com
   - https://icanhazip.com
   - https://ipinfo.io/ip
   - https://httpbin.org/ip

2. **HTTP备用服务**:
   - http://httpbin.org/ip
   - http://icanhazip.com

### 错误处理流程
1. 依次尝试所有HTTPS服务
2. 如果全部失败，尝试HTTP备用服务
3. 记录详细的错误日志
4. 向用户显示友好的错误信息

## 日志查看
在Android Studio的Logcat中查看详细日志：
```
标签: NetworkUtils
级别: Debug/Info/Warning/Error
```

关键日志信息：
- `尝试从 [服务URL] 获取公网IP`
- `成功获取公网IP: [IP地址] (来源: [服务URL])`
- `HTTPS服务都无法访问，尝试HTTP备用服务`
- `所有公网IP服务都无法访问`

## 功能说明
即使公网IP获取失败，应用的核心功能仍然可以正常使用：
- ✅ 局域网内设备连接
- ✅ WebSocket服务
- ✅ TCP服务
- ✅ 文件传输功能

公网IP主要用于：
- 显示完整的连接信息
- 帮助用户了解网络配置
- 便于远程访问配置

## 联系支持
如果问题持续存在，请提供以下信息：
1. 网络环境描述（家庭/企业/校园）
2. 使用的网络类型（WiFi/移动数据）
3. Android设备型号和系统版本
4. Logcat中的相关错误日志